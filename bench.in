#!/bin/bash
#vim: syn=bash

# Global environment
# Modify by using bench_init
BENCH_COLOR=1
BENCH_DEFAULT_LOG=0
BENCH_COUNTER=0

# Initialize (or reset) the benchmarking environment
#
# bench_init use_color default_log
bench_init() {
	BENCH_COLOR=$1
	BENCH_DEFAULT_LOG=$2
	BENCH_COUNTER=0
	return 0
}

# Add a benchmark to the benchmarking environment
#
# bench_add name runs cmd [inf] [outf] [errf]
bench_add() {
	local name="#$BENCH_COUNTER"
	if [ -n "$1" ]
	then
		name="$1"
	fi

	declare -g "BENCH_NAME_$BENCH_COUNTER"="$name"
	declare -g -i "BENCH_RUNS_$BENCH_COUNTER"="$2"
	declare -g "BENCH_CMD_$BENCH_COUNTER"="$3"

	local inf=""
	if [ -n "$4" ]
	then
		inf="$4"
	fi

	local outf="/dev/null"
	if [ -n "$5" ]
	then
		outf="$5"
	elif [ $BENCH_DEFAULT_LOG ]
	then
		errf="bench.$name.log"
	fi

	local errf="/dev/null"
	if [ -n "$6" ]
	then
		errf="$6"
	elif [ $BENCH_DEFAULT_LOG ]
	then
		errf="bench.$name.log"
	fi

	declare -g "BENCH_INF_$BENCH_COUNTER"="$inf"
	declare -g "BENCH_OUTF_$BENCH_COUNTER"="$outf"
	declare -g "BENCH_ERRF_$BENCH_COUNTER"="$errf"

	((++BENCH_COUNTER))
	return 0
}

# Run benchmarks in the benchmarking environment
bench_run() {
	if [ "$BENCH_COUNTER" -eq 0 ]
	then
		return 1
	fi

	if [ $BENCH_COLOR ]
	then
		RED="\033[31m"
		GREEN="\033[32m"
		MAGENTA="\033[35m"
		CLEAR="\033[0m"
		BOLD="\033[1m"
	else
		RED=""
		GREEN=""
		MAGENTA=""
		CLEAN=""
		BOLD=""
	fi

	local old_format="$TIMEFORMAT"
	TIMEFORMAT="%3R %3U %3S"

	local fast_name=""
	local fast_time=$((2 ** 32))

	local slow_name=""
	local slow_time=0

	local today=$(date)
	local start=$(date +%s)

	for ((i=0; i < $BENCH_COUNTER; i++))
	do
		local name="BENCH_NAME_$i"
		local runs="BENCH_RUNS_$i"
		local cmd="BENCH_CMD_$i"
		local inf="BENCH_INF_$i"
		local outf="BENCH_OUTF_$i"
		local errf="BENCH_ERRF_$i"

		name="${!name}"
		runs="${!runs}"
		cmd="${!cmd}"
		inf="${!inf}"
		outf="${!outf}"
		errf="${!errf}"

		echo "==== Benchmark started on $today ====" >> "$outf"
		echo "==== Benchmark started on $today ====" >> "$errf"

		local cmd2="$cmd >>$outf 2>>$errf"
		if [ -n "$inf" ]
		then
			cmd2="cat $inf | $cmd2"
		fi
		cmd2="{ time $cmd2 ; } 2>&1"

		declare -a "real_times"
		declare -a "user_times"
		declare -a "sys_times"

		local errs=0
		for ((j=0; j < $runs; j++))
		do
			local tmp=$(eval "$cmd2"; echo $?)
			local tmp2=($tmp)

			real_times[j]=tmp2[0]
			user_times[j]=tmp2[1]
			sys_times[j]=tmp2[2]

			if [ "${tmp2[3]}" -ne 0 ]
			then
				((++errs))
			fi
		done

		local succs=$((runs - errs))

		echo -e "Benchmark $BOLD$name$CLEAR: $cmd"
		echo -e "  Real time:"
		echo -e "  User time:"
		echo -e "  System time:"
		echo -e "  Runs: $RED$errs$CLEAR errors, $GREEN$succs$CLEAR successes" \
				"over $BOLD$runs$CLEAR runs"

	done

	local end=$(date +%s)
	local total=$((end - start))

	echo "Summary:"
	echo -e "  Total elapsed time: $BOLD$total$CLEAR seconds"
	echo -e "  Fastest benchmark: $BOLD$fast_name$CLEAR ()"
	echo -e "  Slowest benchmark: $BOLD$slow_name$CLEAR ()"

	TIMEFORMAT=old_format
}
